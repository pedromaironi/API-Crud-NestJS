dist: bionic
language: node_js
node_js: '16'

sudo: required
services:
  - docker

branches:
  only:
    - master  

before_script:
  - echo $GCLOUD_SERVICE_KEY | base64 --decode --ignore-garbage > ${HOME}/gcloud-service-key.json
  - gcloud auth activate-service-account --key-file=${HOME}/gcloud-service-key.json
  - gcloud config set project $GCLOUD_PROJECT_ID
  - gcloud config set compute/zone $GCLOUD_COMPUTE_ZONE
  - gcloud container clusters get-credentials app-crud
  - gcloud auth configure-docker --quiet


script:
  - cd App
  - docker build -t nestjs .
  - docker tag nestjs:latest api/ecstatic-galaxy-407119/nestjs:latest
  - docker push api/$GCLOUD_PROJECT_ID/$GCLOUD_CONTAINER_NAME_APP:latest

jobs:
  include:
    - stage: Backend Deployment
      name: 'Run Backend Deployment'
      script:
        - cd App
        - docker build -t nestjs .
        - docker tag nestjs:latest api/ecstatic-galaxy-407119/nestjs:latest
        - docker push api/$GCLOUD_PROJECT_ID/$GCLOUD_CONTAINER_NAME_APP:latest

      deploy:
        provider: script
        script: bash ./deploy.sh
        on:
          branch: master  # Despliegue en la rama 'maste